<!DOCTYPE html>
<html>

<head>
<script>
    var meta = document.createElement('meta');
    meta.name = "viewport";
    meta.content = "width=device-width, initial-scale=1";
    document.getElementsByTagName('head')[0].appendChild(meta);
</script>
</head>
    
    
<body>

<h1>Widget Test Page</h1>
<script>!function(a,b){a("squatch","https://d2rcp9ak152ke1.cloudfront.net/assets/javascripts/v2/squatch.min.js",b)}(function(a,b,c){var d,e,f;c["_"+a]={},c[a]={},c[a].ready=function(b){c["_" + a].ready =  c["_" + a].ready || [];c["_" + a].ready.push(b);},e=document.createElement("script"),e.async=1,e.src=b,f=document.getElementsByTagName("script")[0],f.parentNode.insertBefore(e,f)},this);</script>

<button class="accordion">Widget Configuration</button>
<div class="panel"><br><br>

<form id="widgetForm" action="" method="get">
    Tenant alias: <input type="text" id="tenantAlias" name="tenantAlias"><br><br>
    JWT: <input type="text" id="jwt" name="jwt"><br><br>
    Engagement Medium: <input type="text" id="engagementMedium" name="engagementMedium"><br><br>
    Program ID: <input type="text" id="programId" name="programId"><br><br>
    Widget ID: <input type="text" id="widgetId" name="widgetId"><br><br>
    No Widget?<input type="checkbox" id="isTrackingScript" name="isTrackingScript" value=isTrackingScript> <br><br>
    
    User Object: <textarea rows="8" cols="50" id="userObject" name="userObject"></textarea><br><br>
    
    <input type="button" onclick="submitForm()" value="Submit form">
    
</form>
<br><br><hr><br><br>

</body>
</html>

<style>
.accordion {
  background-color: #eee;
  color: #444;
  cursor: pointer;
  padding: 18px;
  width: 100%;
  border: none;
  text-align: left;
  outline: none;
  font-size: 15px;
  transition: 0.4s;
}
.active, .accordion:hover {
  background-color: #ccc; 
}

.panel {
  padding: 0 18px;
  display: none;
  background-color: white;
  overflow: hidden;
}

</style>

<script>

//code for hiding the widget configuration section
var acc = document.getElementsByClassName("accordion");
var i;

for (i = 0; i < acc.length; i++) {
  acc[i].addEventListener("click", function() {
    this.classList.toggle("active");
    var panel = this.nextElementSibling;
    if (panel.style.display === "block") {
      panel.style.display = "none";
    } else {
      panel.style.display = "block";
    }
  });
}


function submitForm(){
    var userObjectString = document.forms["widgetForm"]["userObject"].value;
    console.log(userObjectString);
    
    var jsonUserObject = JSON.parse(userObjectString);
    
    //TODO: add in try catch check for whether the user object is valid JSON
    console.log(jsonUserObject);
    console.log(JSON.stringify(jsonUserObject))
    //console.log(encodeURIComponent(userObjectString));
    //userObjectString = encodeURIComponent(JSON.stringify(jsonUserObject));
    document.forms["widgetForm"]["userObject"].value = JSON.stringify(jsonUserObject);
    
    //console.log(document.forms["widgetForm"]["userObject"].value);
    
    document.getElementById("widgetForm").submit();
}

function serialize( obj ) {
  return '?'+Object.keys(obj).reduce(function(a,k){a.push(k+'='+encodeURIComponent(obj[k]));return a},[]).join('&')
}



//pickup arguements from URL
var getQueryString = function ( field, url ) {
    var href = url ? url : window.location.href;
    var reg = new RegExp( '[?&]' + field + '=([^&#]*)', 'i' );
    var string = reg.exec(href);
    return string ? string[1] : null;
};

var temp = document.getElementById("tenantAlias");
var tenantAlias = getQueryString('tenantAlias');
temp.value = tenantAlias;

var temp = document.getElementById("jwt");
var jwt = getQueryString('jwt');
temp.value = jwt;

var temp = document.getElementById("engagementMedium");
var engagementMedium = getQueryString('engagementMedium');
temp.value = engagementMedium;

var temp = document.getElementById("programId");
var programId = getQueryString('programId');
temp.value = programId;

var temp = document.getElementById("widgetId");
var widgetId = getQueryString('widgetId');
temp.value = widgetId;

var temp = document.getElementById("userObject");
var userObject = getQueryString('userObject');



//console.log(getQueryString('userObject'));
console.log(userObject);

userObject = JSON.parse(decodeURIComponent(userObject));
console.log(userObject);
temp.value = JSON.stringify(userObject, null, 4);
console.log(temp.value);


var isTrackingScript = getQueryString('isTrackingScript');
if (isTrackingScript == "isTrackingScript"){
    document.getElementById("isTrackingScript").checked = true;
}



if(engagementMedium == "EMBED"){
    var embedDiv = document.createElement("div"); 
    embedDiv.classList.add("squatchembed");
    
    document.body.appendChild(embedDiv);
}

if(engagementMedium == "POPUP"){
    var popupButton = document.createElement("button"); 
    popupButton.classList.add("squatchpop");
    popupButton.innerText = "Referral Widget"
    document.body.appendChild(popupButton);
}


window.squatch.ready(function(){

  //configure squatch.js for the tenant you are using       
  squatch.init({
      tenantAlias: tenantAlias
  });

    var initObj = userObject;
  
  if(jwt){
      initObj["jwt"] = jwt;
  }
  
  if(!isTrackingScript){
      initObj["engagementMedium"] = engagementMedium;
      if(widgetId == "REFERRER"){
          initObj["widgetType"] = "REFERRER";
      }
      else if(widgetId == "CONVERSION_WIDGET"){
          initObj["widgetType"] = "CONVERSION_WIDGET";
      }
      else{
        initObj["widgetType"] = "p/" + programId + "/w/" + widgetId;
      }
  }
  
  console.log(initObj);

  squatch.widgets().upsertUser(initObj).then(function(response) {
    user = response.user;
  }).catch(function(error){
    console.log(error);
  }); 
});


</script>

